ALTER TRIGGER [dbo].[TRIGGER_LENHKHOP]
ON [dbo].[LENHKHOP]
AFTER INSERT
AS
/*DECLARE @MACK NVARCHAR(7) */
BEGIN
 
  DECLARE @MaChungKhoan NCHAR(7),
				@KhoiLuongMua int
		SET @MaChungKhoan = (SELECT LENHDAT.MACK FROM LENHDAT,(SELECT TOP(1) IDLENHDAT FROM inserted) AS MOITHEM WHERE LENHDAT.ID = MOITHEM.IDLENHDAT)
	
		SET @KhoiLuongMua = (SELECT TOP(1) SOLUONGKHOP FROM inserted)
	
	
		UPDATE [dbo].[BANGGIATRUCTUYEN]
			SET GIAMUA = (SELECT TOP(1) GIAKHOP FROM inserted ORDER BY GIAKHOP DESC),
				KHOILUONGMUA = @KhoiLuongMua,
				TONGKHOILUONG = TONGKHOILUONG + @KhoiLuongMua
		WHERE dbo.BANGGIATRUCTUYEN.MACK = @MaChungKhoan

		/*SET @MACK = (SELECT a.MACK FROM LENHDAT a, inserted b WHERE a.ID = b.IDLENHDAT)

		UPDATE BANGGIATRUCTUYEN 
		SET GIAMUA = (SELECT GIAKHOP FROM inserted),
			KHOILUONGMUA = (SELECT SOLUONGKHOP FROM inserted),
			TONGKHOILUONG = TONGKHOILUONG + (SELECT SOLUONGKHOP FROM inserted)
		WHERE BANGGIATRUCTUYEN.MACK = @MACK */
END 